<<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ASTRA-Net Platform | YAKAMI TECH</title>
  <meta name="description" content="Sistema de monitoramento e rastreamento por sat√©lite para a Amaz√¥nia - Tecnologia de √ìrbita Baixa (LEO)" />
  
  <script src="https://cdn.tailwindcss.com"></script>
  
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0f172a;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }
    .leaflet-container { 
      background: #1e293b; 
      border-radius: 12px;
    }
    .vessel-marker { 
      border-radius: 50%; 
      display: flex; 
      align-items: center; 
      justify-content: center; 
      font-size: 10px;
      color: black;
      transition: all 0.3s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      border: 2px solid white;
    }
    .vessel-balsa { background-color: #f97316; }
    .vessel-lancha { background-color: #facc15; }
    .vessel-recreio { background-color: #e5e7eb; }
    .vessel-navio-patrulha { background-color: #3b82f6; color: white;}
    .vessel-carga { background-color: #6b7280; color: white;}
    .vessel-hidrooceanografico { background-color: #10b981; }
    .vessel-hospitalar { background-color: #ef4444; color: white;}
    .animate-pulse-sos {
      animation: pulse-sos 1.5s infinite;
    }
    @keyframes pulse-sos {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
      50% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
    }
    .panel-bg { 
      background: #1e293b; 
      border: 1px solid #334155; 
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .panel-title { 
      border-bottom: 1px solid #334155; 
      padding-bottom: 0.75rem; 
      margin-bottom: 0.75rem; 
      font-size: 1.1rem;
      font-weight: 600;
    }
    
<<<<<<< HEAD
=======
    /* Estilo para a √°rea metropolitana de Manaus */
>>>>>>> dev-melhorias
    .manaus-area {
      fill: rgba(59, 130, 246, 0.15);
      stroke: rgba(59, 130, 246, 0.8);
      stroke-width: 3;
      stroke-dasharray: 5, 5;
    }

<<<<<<< HEAD
=======
    /* Corre√ß√£o para garantir que o mapa ocupe todo o espa√ßo */
>>>>>>> dev-melhorias
    #map {
      width: 100%;
      height: 100%;
      min-height: 600px;
    }

    .main-container {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

<<<<<<< HEAD
=======
    /* Estilo para a logo NASA */
>>>>>>> dev-melhorias
    .nasa-badge {
      background: linear-gradient(135deg, #1a237e, #283593);
      border: 1px solid #3949ab;
    }
  </style>
</head>
<body class="text-gray-200">

  <header class="bg-gray-900/95 backdrop-blur-sm border-b border-gray-700 py-4 sticky top-0 z-50">
    <div class="container mx-auto px-4 flex items-center justify-between">
      <a href="https://www.yakami.com.br/" class="flex items-center space-x-3">
        <div class="bg-orange-500 w-10 h-10 rounded-lg flex items-center justify-center">
          <i class="fas fa-satellite text-white text-lg"></i>
        </div>
        <div>
          <div class="font-bold text-xl">YAKAMI TECH</div>
          <div class="text-xs text-gray-400">ASTRA-Net Platform</div>
        </div>
      </a>
      <div class="nasa-badge text-white px-4 py-2 rounded-full flex items-center space-x-2">
        <i class="fas fa-rocket text-red-400"></i>
        <span class="font-semibold">NASA Space Apps 2025</span>
      </div>
    </div>
  </header>

  <main class="flex-1 container mx-auto px-4 py-6">
<<<<<<< HEAD
=======
    <!-- Cabe√ßalho Principal -->
>>>>>>> dev-melhorias
    <div class="text-center mb-8">
      <h1 class="text-4xl font-bold mb-3 bg-gradient-to-r from-orange-500 to-blue-500 bg-clip-text text-transparent">
        ASTRA-Net Platform
      </h1>
      <p class="text-gray-300 text-lg max-w-3xl mx-auto leading-relaxed">
        Sistema de monitoramento e rastreamento por sat√©lite para a Amaz√¥nia - 
        Tecnologia de √ìrbita Baixa (LEO)
      </p>
    </div>

<<<<<<< HEAD
=======
    <!-- Subt√≠tulo -->
>>>>>>> dev-melhorias
    <div class="text-center mb-8">
      <h2 class="text-2xl font-bold mb-2">DEMONSTRA√á√ÉO INTERATIVA</h2>
      <h3 class="text-xl text-gray-300">Mapa de Monitoramento & Opera√ß√µes Fluviais da Amaz√¥nia</h3>
    </div>

<<<<<<< HEAD
    <div class="grid grid-cols-1 xl:grid-cols-4 gap-6 mb-8">
=======
    <!-- Layout Principal: Mapa + Pain√©is -->
    <div class="grid grid-cols-1 xl:grid-cols-4 gap-6 mb-8">
      <!-- Mapa - Ocupa 3 colunas -->
>>>>>>> dev-melhorias
      <div class="xl:col-span-3 h-[600px]">
        <div id="map" class="w-full h-full rounded-xl border-2 border-gray-600 shadow-2xl"></div>
      </div>

<<<<<<< HEAD
      <div class="xl:col-span-1 space-y-4">
=======
      <!-- Pain√©is Laterais - Ocupa 1 coluna -->
      <div class="xl:col-span-1 space-y-4">
        <!-- Telemetria -->
>>>>>>> dev-melhorias
        <div id="telemetry-panel" class="panel-bg p-5">
          <h3 class="panel-title">Telemetria do Ativo</h3>
          <div class="text-gray-400 text-sm">
            Selecione uma embarca√ß√£o no mapa para ver dados em tempo real.
          </div>
        </div>

<<<<<<< HEAD
=======
        <!-- Orbital -->
>>>>>>> dev-melhorias
        <div id="orbital-panel" class="panel-bg p-5">
          <h3 class="panel-title">Visibilidade Orbital</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-gray-300">Status:</span>
              <span id="orbital-status" class="font-bold text-red-400">N√ÉO VIS√çVEL</span>
            </div>
            <div class="text-sm text-gray-400">
<<<<<<< HEAD
              Pr√≥xima passagem em: <span id="next-pass" class="font-mono text-cyan-300">09:02</span>
=======
              Pr√≥xima passagem em: <span id="next-pass" class="font-mono text-cyan-300">11:29</span>
>>>>>>> dev-melhorias
            </div>
          </div>
        </div>

<<<<<<< HEAD
        <div id="alerts-panel" class="panel-bg p-5">
          <h3 class="panel-title">Alertas e Dados Ambientais</h3>
          <div class="text-sm space-y-2 text-gray-300">
            <div><span class="font-semibold">N√≠veis dos Rios (Portos):</span> Normal</div>
            <div><span class="font-semibold">Alertas de Sat√©lite (NASA):</span> Nenhum</div>
          </div>
        </div>

=======
        <!-- Alertas -->
        <div id="alerts-panel" class="panel-bg p-5">
          <h3 class="panel-title">Co-Piloto e Alertas</h3>
          <div id="alerts-content" class="text-gray-400 text-sm">
            Sistema inicializado. Aguardando dados...
          </div>
        </div>

        <!-- Bot√µes de A√ß√£o -->
>>>>>>> dev-melhorias
        <div class="grid grid-cols-2 gap-4">
          <button onclick="activateSOS()" class="bg-red-600 hover:bg-red-500 text-white px-4 py-3 rounded-lg flex items-center justify-center transition-all duration-200 font-semibold shadow-lg">
            <i class="fas fa-exclamation-triangle mr-2"></i> S.O.S
          </button>
          <button class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-3 rounded-lg flex items-center justify-center transition-all duration-200 font-semibold shadow-lg">
            <i class="fas fa-envelope mr-2"></i> Mensagem
          </button>
        </div>
      </div>
    </div>
    
<<<<<<< HEAD
=======
    <!-- Se√ß√£o NASA - Agora em linha √∫nica -->
>>>>>>> dev-melhorias
    <section class="mb-12">
        <div class="text-center mb-8">
            <h2 class="text-3xl font-bold mb-4">Integra√ß√£o com Dados da NASA</h2>
            <p class="text-gray-300 text-lg max-w-4xl mx-auto">
                Utilizando o ecossistema de dados da NASA para uma opera√ß√£o mais inteligente e segura na Amaz√¥nia
            </p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700 hover:border-blue-500 transition-all duration-300">
                <i class="fas fa-globe-americas text-blue-400 text-3xl mb-4"></i>
                <h3 class="font-bold text-lg mb-3">NASA Earthdata Search</h3>
                <p class="text-gray-300 leading-relaxed">Monitoramento ambiental, an√°lise de desmatamento e qualidade da √°gua dos rios.</p>
            </div>
            <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700 hover:border-yellow-500 transition-all duration-300">
                <i class="fas fa-solar-panel text-yellow-400 text-3xl mb-4"></i>
                <h3 class="font-bold text-lg mb-3">NASA POWER</h3>
                <p class="text-gray-300 leading-relaxed">Previs√£o de irradia√ß√£o solar para otimizar a gera√ß√£o de energia das YAKAMI Eco Stations.</p>
            </div>
            <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700 hover:border-gray-400 transition-all duration-300">
                <i class="fas fa-user-astronaut text-gray-300 text-3xl mb-4"></i>
                <h3 class="font-bold text-lg mb-3">Orbital Debris Program</h3>
                <p class="text-gray-300 leading-relaxed">Planejamento de √≥rbita e mitiga√ß√£o de riscos para a futura constela√ß√£o YAKAMI-SAT.</p>
            </div>
            <div class="bg-gray-800/50 p-6 rounded-xl border border-gray-700 hover:border-green-500 transition-all duration-300">
                <i class="fas fa-broadcast-tower text-green-400 text-3xl mb-4"></i>
                <h3 class="font-bold text-lg mb-3">Satellite Situation Report</h3>
                <p class="text-gray-300 leading-relaxed">Otimiza√ß√£o das janelas de comunica√ß√£o com sat√©lites ativos para garantir a conectividade.</p>
            </div>
        </div>
    </section>

<<<<<<< HEAD
=======
    <!-- Se√ß√£o NORMAM-204 -->
>>>>>>> dev-melhorias
    <section class="bg-blue-900/20 p-8 rounded-2xl border border-blue-700/30">
        <h2 class="text-2xl font-bold mb-6 text-center">Conformidade com a NORMAM-204 da Marinha do Brasil</h2>
        <p class="text-gray-300 mb-6 text-lg leading-relaxed text-center">
            A partir de 1¬∫ de janeiro de 2026, todas as embarca√ß√µes com Arquea√ß√£o Bruta ‚â• 50 est√£o obrigadas a utilizar um sistema de monitoramento AVL (Automatic Vehicle Location) em tempo real.
        </p>
        <ul class="list-none space-y-3 max-w-2xl mx-auto">
            <li class="flex items-start">
                <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                <span class="text-gray-300">O ASTRA-Net √© um <strong class="text-white">Provedor de Servi√ßo de Monitoramento</strong> compat√≠vel com os requisitos da Marinha.</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                <span class="text-gray-300">Nossos dispositivos YAKAMI s√£o certificados pela <strong class="text-white">Anatel</strong> e transmitem dados para o <strong class="text-white">SISTRAM</strong>.</span>
            </li>
            <li class="flex items-start">
                <i class="fas fa-check-circle text-green-400 mt-1 mr-3"></i>
                <span class="text-gray-300">Garantimos <strong class="text-white">180 dias de armazenamento de dados</strong> para auditoria.</span>
            </li>
        </ul>
    </section>
  </main>

  <script>
    // --- INICIALIZA√á√ÉO DO MAPA ---
    const map = L.map('map').setView([-3.1190, -60.0217], 11);
    
<<<<<<< HEAD
=======
    // Tile layer com fallback
>>>>>>> dev-melhorias
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; OpenStreetMap & CARTO',
      maxZoom: 18
    }).addTo(map);

<<<<<<< HEAD
    // --- RIOS PRINCIPAIS ---
    const rios = [
      { nome: "Rio Negro", coords: [[-2.8, -60.5], [-3.0, -60.3], [-3.1, -60.1], [-3.2, -60.0], [-3.3, -59.9], [-3.4, -59.8]] },
      { nome: "Rio Solim√µes", coords: [[-3.1, -60.0], [-3.2, -59.8], [-3.3, -59.6], [-3.4, -59.4]] },
      { nome: "Encontro das √Åguas", coords: [[-3.15, -59.95], [-3.17, -59.92], [-3.19, -59.90]] }
    ];

    // Adicionar camadas de rios
    rios.forEach(rio => {
      L.polyline(rio.coords, { color: '#3b82f6', weight: 5, opacity: 0.8 })
        .addTo(map)
        .bindPopup(`<strong>${rio.nome}</strong>`);
    });

    // Pr√©-processar caminhos dos rios para interpola√ß√£o
    const riverPaths = rios.map(rio => {
      const points = rio.coords.map(pt => L.latLng(pt[0], pt[1]));
      let totalLength = 0;
      const segments = [];
      for (let i = 0; i < points.length - 1; i++) {
        const segLength = points[i].distanceTo(points[i + 1]);
        segments.push({ start: points[i], end: points[i + 1], length: segLength });
        totalLength += segLength;
      }
      return { points, segments, totalLength, name: rio.nome };
    });

    // --- FROTA DE EMBARCA√á√ïES ---
    const vessels = [
      { id: 1, nome: "Balsa Iranduba", empresa: "Barcas Iranduba", tipo: "balsa", rota: "Manaus ‚Üî Iranduba", riverIndex: 0, progress: 0.2, bateria: 88, sinal: -80, velocidade: 8.2, rpm: 1500 },
      { id: 2, nome: "Lancha Janauari", empresa: "COOBARQ", tipo: "lancha", rota: "Manaus ‚Üî Janauari", riverIndex: 0, progress: 0.7, bateria: 92, sinal: -75, velocidade: 18.5, rpm: 2800 },
      { id: 9, nome: "NAsH Oswaldo Cruz", empresa: "Marinha do Brasil", tipo: "hospitalar", rota: "Atendimento Comunidades", riverIndex: 1, progress: 0.4, bateria: 89, sinal: -82, velocidade: 14.2, rpm: 1900 }
=======
    // Adicionar camada de fallback caso a principal falhe
    const fallbackLayer = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18,
      opacity: 0.7,
      zIndex: 999
    });

    // --- DESTAQUE DA √ÅREA METROPOLITANA DE MANAUS ---
    const manausMetroArea = [
      [-3.00, -60.15], [-3.00, -59.85], 
      [-3.30, -59.85], [-3.30, -60.15]
    ];
    
    L.polygon(manausMetroArea, {
      color: '#3b82f6',
      fillColor: '#3b82f6',
      fillOpacity: 0.1,
      weight: 3,
      dashArray: '5, 5',
      className: 'manaus-area'
    }).addTo(map).bindPopup('<strong>√Årea Metropolitana de Manaus</strong><br>Centro de opera√ß√µes ASTRA-Net');

    // --- RIOS PRINCIPAIS ---
    const rios = [
      {
        nome: "Rio Negro",
        coords: [
          [-2.8, -60.5], [-3.0, -60.3], [-3.1, -60.1], 
          [-3.2, -60.0], [-3.3, -59.9], [-3.4, -59.8]
        ]
      },
      {
        nome: "Rio Solim√µes",
        coords: [
          [-3.1, -60.0], [-3.2, -59.8], [-3.3, -59.6], [-3.4, -59.4]
        ]
      },
      {
        nome: "Encontro das √Åguas",
        coords: [
          [-3.15, -59.95], [-3.17, -59.92], [-3.19, -59.90]
        ]
      }
    ];
    
    rios.forEach(rio => {
      L.polyline(rio.coords, {
        color: '#3b82f6',
        weight: 5,
        opacity: 0.8
      }).addTo(map).bindPopup(`<strong>${rio.nome}</strong>`);
    });

    // Estruturas auxiliares para simula√ß√£o nos rios
    const riverPaths = rios.map(rio => ({
      name: rio.nome,
      points: rio.coords.map(pt => L.latLng(pt[0], pt[1])),
      totalLength: 0,
      segments: []
    }));

    // Pr√©-calcula segmentos e comprimentos para interpola√ß√£o suave
    riverPaths.forEach(path => {
      let length = 0;
      for (let i = 0; i < path.points.length - 1; i++) {
        const segLength = path.points[i].distanceTo(path.points[i + 1]);
        path.segments.push({ start: path.points[i], end: path.points[i + 1], length: segLength });
        length += segLength;
      }
      path.totalLength = length;
    });

    // --- PONTOS DE INTERESSE ---
    const pointsOfInterest = [
        { nome: "Porto de Manaus", lat: -3.134, lng: -59.992, type: 'porto-organizado' },
        { nome: "Porto Chibat√£o", lat: -3.145, lng: -60.025, type: 'porto-container' },
        { nome: "Base da Marinha (9¬∫ DN)", lat: -3.1100, lng: -60.0100, type: 'marinha' },
        { nome: "Comunidade Janauari", lat: -3.22, lng: -60.15, type: 'comunidade' },
        { nome: "Comunidade do Tup√©", lat: -3.05, lng: -60.25, type: 'comunidade' },
        { nome: "Aeroporto de Manaus", lat: -3.0386, lng: -60.0497, type: 'aeroporto' },
        { nome: "Centro de Manaus", lat: -3.1190, lng: -60.0217, type: 'centro' }
    ];

    pointsOfInterest.forEach(p => {
        let iconHtml, iconClass;
        switch(p.type) {
            case 'porto-organizado': 
                iconHtml = '<i class="fas fa-ship"></i>'; 
                iconClass = 'text-amber-500 bg-amber-500/20 p-2 rounded-full'; 
                break;
            case 'porto-container': 
                iconHtml = '<i class="fas fa-warehouse"></i>'; 
                iconClass = 'text-gray-400 bg-gray-400/20 p-2 rounded-full'; 
                break;
            case 'marinha': 
                iconHtml = '<i class="fas fa-shield-alt"></i>'; 
                iconClass = 'text-blue-600 bg-blue-600/20 p-2 rounded-full'; 
                break;
            case 'comunidade': 
                iconHtml = '<i class="fas fa-users"></i>'; 
                iconClass = 'text-green-400 bg-green-400/20 p-2 rounded-full'; 
                break;
            case 'aeroporto': 
                iconHtml = '<i class="fas fa-plane"></i>'; 
                iconClass = 'text-red-400 bg-red-400/20 p-2 rounded-full'; 
                break;
            case 'centro': 
                iconHtml = '<i class="fas fa-city"></i>'; 
                iconClass = 'text-white bg-white/20 p-2 rounded-full'; 
                break;
            default: 
                iconHtml = '<i class="fas fa-map-marker-alt"></i>'; 
                iconClass = 'text-white bg-white/20 p-2 rounded-full';
        }
        const icon = L.divIcon({ 
            className: `point-marker ${iconClass}`, 
            html: iconHtml, 
            iconSize: [40, 40],
            iconAnchor: [20, 20]
        });
        L.marker([p.lat, p.lng], { icon: icon })
          .addTo(map)
          .bindPopup(`<strong>${p.nome}</strong><br><small>${p.type.toUpperCase()}</small>`);
    });

    // --- FROTA DE EMBARCA√á√ïES ---
    const vessels = [
      { 
        id: 1, 
        nome: "Balsa Iranduba", 
        empresa: "Barcas Iranduba", 
        tipo: "balsa", 
        rota: "Manaus ‚Üî Iranduba", 
        riverIndex: 0, // Rio Negro
        progress: 0.3,
        bateria: 88, 
        sinal: -80, 
        velocidade: 8.2, 
        rpm: 1500 
      },
      { 
        id: 2, 
        nome: "Lancha Janauari", 
        empresa: "COOBARQ", 
        tipo: "lancha", 
        rota: "Manaus ‚Üî Janauari", 
        riverIndex: 0, // Rio Negro
        progress: 0.6,
        bateria: 92, 
        sinal: -75, 
        velocidade: 18.5, 
        rpm: 2800 
      },
      { 
        id: 9, 
        nome: "NAsH Oswaldo Cruz", 
        empresa: "Marinha do Brasil", 
        tipo: "hospitalar", 
        rota: "Atendimento Comunidades", 
        riverIndex: 1, // Rio Solim√µes
        progress: 0.45,
        bateria: 89, 
        sinal: -82, 
        velocidade: 14.2, 
        rpm: 1900 
      }
>>>>>>> dev-melhorias
    ];

    const vesselMarkers = {};
    let selectedVessel = null;
    let alerts = [];
    let passSchedule = [];

<<<<<<< HEAD
    // --- FUN√á√ïES ---
    function getVesselIcon(type) {
      const icons = { balsa: 'ship', lancha: 'bolt', hospitalar: 'hospital', carga: 'box', hidrooceanografico: 'water', 'navio-patrulha': 'shield-alt', recreio: 'ship' };
      return icons[type] || 'ship';
    }

    function getPointOnRiver(river, progress) {
      if (progress <= 0) return river.points[0];
      if (progress >= 1) return river.points[river.points.length - 1];
      const target = progress * river.totalLength;
      let current = 0;
      for (const seg of river.segments) {
        if (current + seg.length >= target) {
          const ratio = (target - current) / seg.length;
          const lat = seg.start.lat + ratio * (seg.end.lat - seg.start.lat);
          const lng = seg.start.lng + ratio * (seg.end.lng - seg.start.lng);
          return L.latLng(lat, lng);
        }
        current += seg.length;
      }
      return river.points[river.points.length - 1];
=======
    // --- FUN√á√ïES PRINCIPAIS ---
    function getVesselIcon(type) {
        const icons = { 
            balsa: 'ship', 
            lancha: 'bolt', 
            recreio: 'ship', 
            'navio-patrulha': 'shield-alt', 
            carga: 'box', 
            hidrooceanografico: 'water', 
            hospitalar: 'hospital' 
        };
        return icons[type] || 'ship';
>>>>>>> dev-melhorias
    }

    // Calcula posi√ß√£o ao longo do rio com base na progress√£o
    function getPointOnRiver(riverPath, progress) {
      if (progress <= 0) return riverPath.points[0];
      if (progress >= 1) return riverPath.points[riverPath.points.length - 1];
      
      const targetDist = progress * riverPath.totalLength;
      let currentDist = 0;
      
      for (const seg of riverPath.segments) {
        if (currentDist + seg.length >= targetDist) {
          const segProgress = (targetDist - currentDist) / seg.length;
          const lat = seg.start.lat + segProgress * (seg.end.lat - seg.start.lat);
          const lng = seg.start.lng + segProgress * (seg.end.lng - seg.start.lng);
          return L.latLng(lat, lng);
        }
        currentDist += seg.length;
      }
      return riverPath.points[riverPath.points.length - 1];
    }

    function renderVessels() {
      vessels.forEach(v => {
        const river = riverPaths[v.riverIndex];
        const pos = getPointOnRiver(river, v.progress);
        v.lat = pos.lat;
        v.lng = pos.lng;

<<<<<<< HEAD
        const icon = L.divIcon({
=======
        const el = L.divIcon({
>>>>>>> dev-melhorias
          className: `vessel-marker vessel-${v.tipo} ${selectedVessel?.id === v.id ? 'border-yellow-400 scale-125 ring-2 ring-yellow-400' : 'border-white'} ${v.sosActive ? 'animate-pulse-sos' : ''}`,
          html: `<i class="fas fa-${getVesselIcon(v.tipo)} text-xs"></i>`,
          iconSize: [28, 28],
          iconAnchor: [14, 14]
        });
<<<<<<< HEAD

=======
        
>>>>>>> dev-melhorias
        if (vesselMarkers[v.id]) {
          vesselMarkers[v.id].setLatLng([v.lat, v.lng]).setIcon(icon);
        } else {
<<<<<<< HEAD
          vesselMarkers[v.id] = L.marker([v.lat, v.lng], { icon })
            .addTo(map)
            .bindPopup(`<div class="font-semibold">${v.nome}</div><div class="text-sm text-gray-600">${v.empresa}</div><div class="text-xs text-blue-600">${v.rota}</div>`)
            .on('click', () => selectVessel(v));
=======
            vesselMarkers[v.id] = L.marker([v.lat, v.lng], { icon: el })
                .addTo(map)
                .bindPopup(`
                  <div class="font-semibold">${v.nome}</div>
                  <div class="text-sm text-gray-600">${v.empresa}</div>
                  <div class="text-xs text-blue-600">${v.rota}</div>
                `)
                .on('click', () => selectVessel(v));
>>>>>>> dev-melhorias
        }
      });
    }

    function selectVessel(v) {
      selectedVessel = v;
      updateTelemetryPanel();
<<<<<<< HEAD
=======
      updateAlertsPanel();
      renderVessels();
>>>>>>> dev-melhorias
      map.setView([v.lat, v.lng], 13);
    }

    function activateSOS() {
      if (!selectedVessel) {
        alert('‚ö†Ô∏è Selecione uma embarca√ß√£o no mapa antes de ativar o S.O.S');
        return;
      }
      selectedVessel.sosActive = true;
<<<<<<< HEAD
      setTimeout(() => {
        if (selectedVessel) selectedVessel.sosActive = false;
        renderVessels();
      }, 10000);
      renderVessels();
    }

    function updateTelemetryPanel() {
      const panel = document.getElementById('telemetry-panel');
      if (!selectedVessel) {
        panel.innerHTML = `<h3 class="panel-title">Telemetria do Ativo</h3><div class="text-gray-400 text-sm"><i class="fas fa-mouse-pointer mr-2"></i>Clique em uma embarca√ß√£o no mapa</div>`;
        return;
      }
      const v = selectedVessel;
      panel.innerHTML = `
        <h3 class="panel-title">${v.nome}</h3>
        <div class="space-y-3">
          <div class="flex justify-between items-center"><span class="text-gray-400">Empresa:</span><span class="font-semibold">${v.empresa}</span></div>
          <div class="flex justify-between items-center"><span class="text-gray-400">Rota:</span><span class="text-blue-400 font-semibold">${v.rota}</span></div>
          <div class="border-t border-gray-700 pt-3 space-y-2">
            <div class="flex justify-between items-center"><span class="text-gray-400">Posi√ß√£o:</span><span class="font-mono text-sm">${v.lat.toFixed(4)}, ${v.lng.toFixed(4)}</span></div>
            <div class="flex justify-between items-center"><span class="text-gray-400">Velocidade:</span><span class="text-yellow-400 font-semibold">${v.velocidade.toFixed(1)} n√≥s</span></div>
            <div class="flex justify-between items-center"><span class="text-gray-400">RPM:</span><span class="font-semibold">${v.rpm.toFixed(0)}</span></div>
            <div class="flex justify-between items-center"><span class="text-gray-400">Bateria:</span><span class="text-green-400 font-semibold">${v.bateria.toFixed(0)}%</span></div>
          </div>
        </div>
      `;
    }

    function updateOrbitalPanel() {
      const now = new Date();
      if (!passSchedule.length || passSchedule[0].time <= now) {
        const sats = ["YAKAMI-SAT-01", "Starlink", "TERRA (NASA)", "AQUA (NASA)"];
        passSchedule = [];
        for (let i = 0; i < 3; i++) {
          passSchedule.push({ 
            sat: sats[Math.floor(Math.random() * sats.length)], 
            time: new Date(now.getTime() + (i * 15 + Math.random() * 10) * 60000), 
            dur: 6 + Math.floor(Math.random() * 4) 
          });
        }
        passSchedule.sort((a,b) => a.time - b.time);
      }
      
      const next = passSchedule[0];
      const timeToPass = next.time - now;
      
      if (timeToPass > 0) {
        const mins = Math.floor(timeToPass / 60000);
        const secs = Math.floor((timeToPass % 60000) / 1000);
        document.getElementById('orbital-status').textContent = "N√ÉO VIS√çVEL";
        document.getElementById('orbital-status').className = "font-bold text-red-400";
        document.getElementById('next-pass').textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
      } else if (timeToPass > -next.dur * 60000) {
        document.getElementById('orbital-status').textContent = "VIS√çVEL";
        document.getElementById('orbital-status').className = "font-bold text-green-400";
        const remaining = Math.floor((next.dur * 60000 + timeToPass) / 1000);
        document.getElementById('next-pass').textContent = `FIM: ${String(Math.floor(remaining/60)).padStart(2, '0')}:${String(remaining%60).padStart(2, '0')}`;
      }
    }
=======
      addAlert('SOS', `üö® Sinal de SOS ativado para ${selectedVessel.nome}!`);
      renderVessels();
      
      // Auto-reset ap√≥s 10 segundos
      setTimeout(() => {
        if (selectedVessel) {
          selectedVessel.sosActive = false;
          renderVessels();
        }
      }, 10000);
    }

    function updateTelemetryPanel() {
        const panel = document.getElementById('telemetry-panel');
        if (!selectedVessel) {
            panel.innerHTML = `
                <h3 class="panel-title">Telemetria do Ativo</h3>
                <div class="text-gray-400 text-sm">
                    <i class="fas fa-mouse-pointer mr-2"></i>Clique em uma embarca√ß√£o no mapa
                </div>
            `;
            return;
        }
        
        const v = selectedVessel;
        panel.innerHTML = `
            <h3 class="panel-title">${v.nome}</h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center">
                    <span class="text-gray-400">Empresa:</span>
                    <span class="font-semibold">${v.empresa}</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-gray-400">Rota:</span>
                    <span class="text-blue-400 font-semibold">${v.rota}</span>
                </div>
                <div class="border-t border-gray-700 pt-3 space-y-2">
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Posi√ß√£o:</span>
                        <span class="font-mono text-sm">${v.lat.toFixed(4)}, ${v.lng.toFixed(4)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Velocidade:</span>
                        <span class="text-yellow-400 font-semibold">${v.velocidade.toFixed(1)} n√≥s</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">RPM:</span>
                        <span class="font-semibold">${v.rpm.toFixed(0)}</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-gray-400">Bateria:</span>
                        <span class="text-green-400 font-semibold">${v.bateria.toFixed(0)}%</span>
                    </div>
                </div>
            </div>
        `;
    }

    function addAlert(type, msg) {
        alerts.unshift({ 
            type, 
            msg, 
            time: new Date().toLocaleTimeString('pt-BR', { hour12: false }) 
        });
        if (alerts.length > 5) alerts.pop();
        updateAlertsPanel();
    }

    function updateAlertsPanel() {
        const panel = document.getElementById('alerts-panel');
        let alertsContent = '';
        
        if (alerts.length > 0) {
            alertsContent = alerts.map(alert => 
                `<div class="text-sm mb-2 p-2 rounded ${alert.type === 'SOS' ? 'bg-red-500/20 text-red-300 border border-red-500/30' : 'bg-blue-500/20 text-blue-300'}">
                    <span class="font-mono text-xs">[${alert.time}]</span> ${alert.msg}
                </div>`
            ).join('');
        } else {
            alertsContent = '<div class="text-gray-400 text-sm">Nenhum alerta no momento</div>';
        }
        
        panel.innerHTML = `
            <h3 class="panel-title">Co-Piloto e Alertas</h3>
            <div class="space-y-2 max-h-40 overflow-y-auto">
                ${alertsContent}
            </div>
        `;
    }

    function updateOrbitalPanel() {
        const now = new Date();
        
        // Gerar passagens se necess√°rio
        if (!passSchedule.length || passSchedule[0].time < now) {
            const sats = ["YAKAMI-SAT-01", "Starlink", "TERRA (NASA)", "AQUA (NASA)"];
            passSchedule = [];
            for (let i = 0; i < 3; i++) {
                passSchedule.push({ 
                    sat: sats[Math.floor(Math.random() * sats.length)], 
                    time: new Date(now.getTime() + (i * 10 + Math.random() * 15) * 60000), 
                    dur: 5 + Math.floor(Math.random() * 5) 
                });
            }
            passSchedule.sort((a,b) => a.time - b.time);
        }
        
        const next = passSchedule[0];
        const timeToPass = next.time - now;
        
        let statusText = "N√ÉO VIS√çVEL", statusColor = "text-red-400", countdownText = "";
        
        if (timeToPass < 0 && timeToPass > -next.dur * 60000) {
            statusText = "VIS√çVEL"; 
            statusColor = "text-green-400";
            const remaining = Math.floor((next.dur * 60000 + timeToPass) / 1000);
            countdownText = `Fim em: <span class="font-mono font-bold">${String(Math.floor(remaining/60)).padStart(2,'0')}:${String(remaining%60).padStart(2,'0')}</span>`;
        } else {
            const diff = Math.max(0, Math.floor(timeToPass / 1000));
            countdownText = `Pr√≥xima em: <span class="font-mono font-bold">${String(Math.floor(diff/60)).padStart(2,'0')}:${String(diff%60).padStart(2,'0')}</span>`;
        }
        
        // Atualizar elementos da UI
        document.getElementById('orbital-status').textContent = statusText;
        document.getElementById('orbital-status').className = `font-bold ${statusColor}`;
        document.getElementById('next-pass').innerHTML = countdownText.split(": ")[1];
    }

    // --- SIMULA√á√ÉO EM TEMPO REAL ---
    function simulateMovement() {
        vessels.forEach(v => {
            // Movimento suave ao longo do rio
            v.progress += (Math.random() - 0.5) * 0.01;
            if (v.progress < 0) v.progress = 0;
            if (v.progress > 1) v.progress = 1;

            v.velocidade += (Math.random() - 0.5) * 0.1;
            v.velocidade = Math.max(5, Math.min(25, v.velocidade));
            v.rpm += (Math.random() - 0.5) * 10;
            v.bateria -= 0.02;
            if (v.bateria < 15) v.bateria = 100;
        });
        renderVessels();
        if (selectedVessel) updateTelemetryPanel();
    }

    // --- INICIALIZA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', function() {
        renderVessels();
        updateTelemetryPanel();
        updateAlertsPanel();
        updateOrbitalPanel();
        
        // Alerta de sistema inicializado
        setTimeout(() => {
            addAlert('SISTEMA', 'Sistema ASTRA-Net inicializado com sucesso');
        }, 1000);
        
        // Configurar intervalos
        setInterval(updateOrbitalPanel, 1000);
        setInterval(simulateMovement, 3000);
        
        // For√ßar redimensionamento do mapa ap√≥s carregamento
        setTimeout(() => {
            map.invalidateSize();
        }, 100);

        // Adicionar fallback layer apenas se necess√°rio
        map.on('tileerror', function() {
            if (!map.hasLayer(fallbackLayer)) {
                fallbackLayer.addTo(map);
            }
        });
    });
>>>>>>> dev-melhorias

    function simulateMovement() {
      vessels.forEach(v => {
        const speedFactor = v.velocidade / 20; // Normalizar velocidade
        v.progress += (Math.random() > 0.5 ? 1 : -1) * 0.005 * speedFactor;
        if (v.progress < 0) v.progress = 0;
        if (v.progress > 1) v.progress = 1;

        v.velocidade = Math.max(5, Math.min(25, v.velocidade + (Math.random() - 0.5) * 0.2));
        v.rpm = Math.max(800, Math.min(3500, v.rpm + (Math.random() - 0.5) * 20));
        v.bateria = Math.max(10, Math.min(100, v.bateria - 0.03));
        if (v.bateria <= 15) v.bateria = 100;
      });
      renderVessels();
      if (selectedVessel) updateTelemetryPanel();
    }

    // --- INICIALIZA√á√ÉO ---
    document.addEventListener('DOMContentLoaded', () => {
      // Pol√≠gono de Manaus
      const manausArea = L.polygon([
        [-3.00, -60.15], [-3.00, -59.85], [-3.30, -59.85], [-3.30, -60.15]
      ], {
        color: '#3b82f6',
        fillColor: '#3b82f6',
        fillOpacity: 0.1,
        weight: 3,
        dashArray: '5, 5'
      }).addTo(map).bindPopup('<strong>√Årea Metropolitana de Manaus</strong><br>Centro de opera√ß√µes ASTRA-Net');

      renderVessels();
      updateTelemetryPanel();
      updateOrbitalPanel();
      
      setInterval(updateOrbitalPanel, 1000);
      setInterval(simulateMovement, 2000);

      setTimeout(() => map.invalidateSize(), 100);
    });
  </script>
</body>
</html>

